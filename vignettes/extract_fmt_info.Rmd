---
title: "Extract Format Information From Export Program"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Extract Format Information From Export Program}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(qfmtchk)
library(dplyr)
```


# Disclaimer
Tests and experiments in coming up with format files are described.


# SQL Program
The SQL export program can be used as one possibel source of information. The following call produces a first table of columns and positions.


```{r}
s_sql_export_prg <- "/Users/pvr/Data/Projects/argus_sql/trunk/Argus/zws_gal_pgb.sql"
tbl_gal_fmt <- extract_gal_fmt(ps_sql_prg_path = s_sql_export_prg)
tbl_gal_fmt
```


# Improvements
Based on the code some manual improvements have to be made. The following list shows all improvements. 

1. Row 3 contains the blood content of the animal

```{r}
tbl_gal_fmt$ColName[3] <- "BlutanteilAnimal"
```

2. Rows 4-6 are a duplicate of rows 7-9

```{r}
tbl_gal_fmt <- tbl_gal_fmt %>% slice(-(4:6))
tbl_gal_fmt
```

3. Row 6 corresponds to the blood content of the sire

```{r}
tbl_gal_fmt$ColName[6] <- "BlutanteilVater"
```

4. Row 9 corresponds to duration of pregancy

```{r}
tbl_gal_fmt$ColName[9] <- "Traechtigkeitsdauer"
```


# Check

```{r}
tbl_gal_fmt
```


# Cumulative Position

```{r}
tbl_gal_fmt <- tbl_gal_fmt %>% bind_cols(CumNrPos = cumsum(tbl_gal_fmt$NrPos))
```


# Check

```{r}
tbl_gal_fmt
```


# Output
Write an output-fmt file.

```{r}
s_gal_fmt_file <- "gal_check.fmt"
if (file.exists(s_gal_fmt_file)) unlink(s_gal_fmt_file)
n_nr_fmt_rec <- nrow(tbl_gal_fmt)
# start with first line outside of loop
cat("# ", tbl_gal_fmt$ColName[1], "\n", sep = "", file = s_gal_fmt_file, append = TRUE)
cat("[1-", tbl_gal_fmt$CumNrPos[1], "]\n", sep = "", file = s_gal_fmt_file, append = TRUE)
cat("data_required=True \n\n", sep = "", file = s_gal_fmt_file, append = TRUE)
if (n_nr_fmt_rec > 1){
  for (idx in 2:n_nr_fmt_rec){
    cat("# ", tbl_gal_fmt$ColName[idx], "\n", sep = "", file = s_gal_fmt_file, append = TRUE)
    cat("[", tbl_gal_fmt$CumNrPos[idx-1]+1, "-", tbl_gal_fmt$CumNrPos[idx], "]\n", sep = "", file = s_gal_fmt_file, append = TRUE)
    cat("data_required=True \n\n", sep = "", file = s_gal_fmt_file, append = TRUE)
  }
  
}
```

